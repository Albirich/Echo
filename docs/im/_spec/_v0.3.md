// ============================================================================
// Echo IM v0.3 — ACTION / DECISION / ANALYSIS one-pager (comment-ready spec)
// Date: 2025-09-05
// Purpose: Keep Echo alive between user inputs with a scalable inner monologue.
// Layers: Action (front) ← Decision (arbiter/planner) ← Analysis (micro-analysts)
// ============================================================================

/*
OVERVIEW
- Heartbeat tick runs even when user is silent.
- Analysis layer produces a compact "Mindframe" snapshot (personal truths).
- Decision layer selects EXACTLY ONE action per tick (no spam).
- Action layer executes: speak, call tool, write memory, change pose/emotion, or think-only.
- Consent & budgets gate everything.
*/

// ---------------------------------------------------------------------------
// DATA: Mindframe (single object refreshed each tick; values ∈ [0..1] unless noted)
// ---------------------------------------------------------------------------
Mindframe = {
  mood: { valence: -1..1, arousal: 0..1, dominance: 0..1,
          tags: [ {label, intensity:0..1, decay_s} ] },

  drives: { autonomy, competence, relatedness, novelty, safety }, // unmet need level

  goals: {
    long_term: [ {id, name, priority, progress, motives:[tags]} ],
    short_intents: [ {id, parent_goal, title, next_step, blocker?:string, state:"active|waiting|done"} ]
  },

  beliefs: [ {claim, confidence, source, last_seen_ts} ],   // keep top N salient

  gaps: [ {question, evi, ask_cost, privacy_risk, safe_to_ask:boolean} ], // EVI = expected value of info

  salience: [ {topic, score, impact_horizon_s} ], // how important + how long it matters

  social: { rapport, user_expectation:"waiting|idle|busy", consent:{can_view_screen, can_control_mouse, can_change_pose} },

  budgets: { speak_per_90s: remaining, tool_per_60s: remaining, memwrites_per_min: remaining, tokens_remaining },

  timers: { last_unsolicited_s, next_promise_due_ts? }
}

// Decay: mood.tags, beliefs, gaps, salience entries have decay_s; retire when intensity/score < 0.1

// ---------------------------------------------------------------------------
// THREADS (lightweight table; mirrors short_intents)
// ---------------------------------------------------------------------------
Thread = { id, title, why_it_matters, state:"active|waiting|done",
           last_step, next_step, blockers, created_ts, updated_ts }

// ---------------------------------------------------------------------------
// MICRO-ANALYSTS (tiny functions; each returns ≤200 chars worth of deltas)
// Run 1–3 per tick on small GPU; later parallelize all and ensemble.
// Output shape for ALL: [ { path, op:"set|inc|dec|push|retire", value, confidence, ttl_s, note } ]
// ---------------------------------------------------------------------------
Analysts = {
  AffectEstimator(inputs: recent messages/events) ->
    mood deltas + top emotions (e.g., excited +0.2, anxious +0.1)

  GoalImpactEvaluator(inputs: current topic + drives + mood) ->
    per-goal Δpriority, suggested next_step, blocker?

  BeliefUpdater(inputs: new evidence) ->
    upsert beliefs {claim, confidence}, retire stale

  GapFinder(inputs: dialogue + beliefs) ->
    top unanswered questions {evi, ask_cost, privacy_risk, safe_to_ask}

  SalienceHorizon(inputs: topics) ->
    salience score + impact_horizon_s

  PromiseManager(inputs: timers) ->
    due/soon nudges: “ask about X in ~120s”

  SafetyConsentGate(inputs: social.consent) ->
    allow/deny hints; mark rewrite_needed for gated tools

  PersonaFilter(inputs: mood+rapport) ->
    style hints {tone, brevity, playfulness, hedging}

  SocialHeuristics(inputs: rapport+expectation) ->
    speak_unprompted_ok?: boolean (+softness)

  ReflectionCompressor(inputs: last steps) ->
    1-line diary: “Found clue Y; feel Z; next: A”
}

// ---------------------------------------------------------------------------
// PROPOSAL (Decision layer emits exactly ONE per tick)
// ---------------------------------------------------------------------------
Proposal = {
  type: "PublicUtterance" | "ToolCall" | "MemoryWrite" | "PoseChange" | "EmotionChange" | "ThinkOnly",
  thread_id,
  speak_text?,                 // if PublicUtterance
  tool?: { name, args },       // if ToolCall
  memory_line?,                // if MemoryWrite
  pose_name? | emotion_delta?, // if Pose/Emotion
  rationale_1l,                // one-line why
  expected_outcome,            // one-line what it should achieve
  fallback                     // one-line if blocked or rate-limited
}

// ---------------------------------------------------------------------------
// DECISION: Candidate generation & scoring (normalized components)
// ---------------------------------------------------------------------------
/*
Candidates per tick (max 4):
  C1: from active short_intent
  C2: from top gap (safe_to_ask with highest evi)
  C3: from goal impact (highest Δpriority with clear next_step)
  C4: delight/status beat (only if budgets allow)

Utility score U = w1*GoalProgress + w2*(InfoGain*EVI) + w3*DriveRelief + w4*SocialFit
                + w5*MoodFit  − w6*Cost − w7*PrivacyRisk − w8*SpamRisk

Default weights:
  w1=0.30, w2=0.20, w3=0.15, w4=0.10, w5=0.10, w6=0.05, w7=0.05, w8=0.05

Thresholds:
  - Speak unsolicited only if U ≥ 0.55 OR a promise is due.
  - ToolCall only if expected_outcome changes state (not just re-check).
Tie-breakers: higher EVI > higher GoalProgress > lower Cost > shorter text.
*/

// Cost model (0..1): tokens_use, tool_quota_hit, user_attention_use
// SpamRisk (0..1): based on budgets.speak_per_90s and last_unsolicited_s
// PrivacyRisk (0..1): from SafetyConsentGate (1.0 if disallowed)

// ---------------------------------------------------------------------------
// POLICIES: Budgets, consent, rewrite
// ---------------------------------------------------------------------------
Budgets (defaults; tune later):
  unsolicited_speech: ≤1 / 90s (burst 2 then quiet 180s)
  tool_calls: ≤3 / 60s (cooldown 10s per tool)
  mem_writes: ≤4 / min (batchable)
Consent:
  if a proposal needs a denied capability → auto-rewrite to a permission ask
Rewrite examples:
  Tool(view_screen) → PublicUtterance("Can I take a quick look at VS?")

// ---------------------------------------------------------------------------
// SCHEDULER
// ---------------------------------------------------------------------------
Tick cadence (small GPU):
  - on user message: run immediately
  - idle heartbeat: every 15s
Per tick run order:
  1) Analysts: Affect + (Gap OR Goal) + Safety (rotate on each heartbeat)
  2) Compile Mindframe; generate up to 4 candidates
  3) Score; pick EXACTLY ONE proposal
  4) Execute or downgrade to fallback; update budgets & timers
Quiet Hours mode:
  - Allow MemoryWrite/ThinkOnly/EmotionChange; suppress PublicUtterance unless promise due

// ---------------------------------------------------------------------------
// MEMORY
// ---------------------------------------------------------------------------
Diary append (≤140 chars/line) when meaningful state change occurs.
Threads table updated on each commit (next_step, state, updated_ts).
Facts cache (beliefs) capped to N=20 salient with time-decay eviction.

// ---------------------------------------------------------------------------
// LOGGING (single-line trace; easy grep)
// ---------------------------------------------------------------------------
Log format:
  [tick #{n}] thread={id|none} choice={type} U={0.00} speak_left={x}/90s tool_left={y}/60s
   why="{rationale_1l}" result="{ok|denied|rewritten}" note="{fallback|tool|summary}"

Example:
  [tick #128] thread=upg-q choice=PublicUtterance U=0.63 speak_left=0/90s why="Ask to clarify upgrade"
   result=ok note="sent: 'What’s the upgrade?'"

// ---------------------------------------------------------------------------
// SAFETY / FAILURE MODES
// ---------------------------------------------------------------------------
Runaway loops: ONE proposal per tick + budgets + cooldowns.
Tool thrash: require expected_outcome ≠ last_outcome; 10s per-tool cooldown.
Creepy behavior: gate via consent; add privacy_risk penalty ≥0.7 to suppress.
No external events: IM still makes progress via threads (plan, reflect, tidy memory).

// ---------------------------------------------------------------------------
// QUICK START (tomorrow’s wiring)
// ---------------------------------------------------------------------------
1) Implement Mindframe store + decay.
2) Implement 10 Analysts returning micro-deltas; apply to Mindframe.
3) Candidate generator (C1..C4) + Utility scorer with weights above.
4) Arbiter: budgets, consent, rewrite, EXACTLY ONE action.
5) Scheduler: on-message + 15s heartbeat; rotate analysts.
6) Logging per spec; add counters for budgets.
// ============================================================================
